<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>THE WATCHING ‚Äî Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root{
 --bg:#000;--panel:#050505;--accent:#b30000;
 --line:#300;--text:#e6e6e6;
 --my1:#2a0000;--my2:#120000
}
*{box-sizing:border-box}
body{margin:0;background:#000;color:var(--text);font-family:system-ui,monospace;overflow-x:hidden}

/* UI unchanged */
#top{position:fixed;top:0;left:0;right:0;z-index:5;display:flex;gap:8px;align-items:center;padding:6px 8px;background:#000;border-bottom:1px solid var(--line)}
#centerSearch{flex:1;text-align:center}
#centerSearch input{width:180px;background:#000;color:#eee;border:1px solid var(--line);border-radius:8px;padding:4px;font-size:12px}
button{background:#000;color:#ff6b6b;border:1px solid var(--accent);border-radius:8px;padding:4px 8px;font-size:12px}

#privatePanel{position:fixed;top:42px;left:0;bottom:0;width:165px;background:var(--panel);border-right:1px solid var(--line);transform:translateX(-100%);transition:.25s;z-index:4;padding:6px;overflow-y:auto}
#privatePanel.open{transform:translateX(0)}

#chat{position:fixed;left:0;right:0;bottom:0;top:42px;display:flex;flex-direction:column}
#messages{flex:1;overflow-y:auto;padding:8px}

.msg{width:100%;display:flex;margin-bottom:6px}
.msg.me{justify-content:flex-end}
.bubble{display:inline-flex;flex-direction:column;width:fit-content;max-width:78%;background:#080808;border:1px solid var(--line);border-radius:10px;padding:4px 6px;font-size:12px}
.msg.me .bubble{background:linear-gradient(180deg,var(--my1),var(--my2));border:1px solid #550000}

/* VIDEO */
.videoSquare{width:96px;height:96px;border-radius:12px;overflow:hidden;border:2px solid #550000;background:#120000;position:relative}
.videoSquare video{width:100%;height:100%;object-fit:cover}
.timer{position:absolute;bottom:2px;right:4px;font-size:10px;color:#fff;background:rgba(0,0,0,.5);padding:1px 4px;border-radius:4px}

/* reactions */
.reactions{display:flex;gap:4px;margin-top:2px;font-size:12px;cursor:pointer}
.reactions span{opacity:.7}
.reactions span:hover{opacity:1}

/* INPUT */
#inputBar{display:flex;gap:6px;padding:6px;border-top:1px solid var(--line)}
textarea{flex:1;background:#000;color:#eee;border:1px solid var(--line);border-radius:8px;padding:6px;resize:none}
#camBtn{width:34px;height:34px;border-radius:6px;background:#120000;border:1px solid #b30000;color:#ff6b6b;display:flex;align-items:center;justify-content:center;font-size:11px}
#camBtn.rec{background:#b30000;color:#000}
</style>
</head>
<body>

<div id="top">
 <button onclick="togglePrivate()">‚ò∞</button>
 <button onclick="goPublic()">–û–±—â–∏–π</button>
 <div id="centerSearch">
  <input id="search" placeholder="–ø–æ–∏—Å–∫ –ø–æ ID">
 </div>
 <button>–ü—Ä–æ—Ñ–∏–ª—å</button>
</div>

<div id="privatePanel"></div>

<div id="chat">
 <div id="messages"></div>
 <div id="inputBar">
  <textarea id="text" placeholder="—Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶"></textarea>
  <div id="camBtn">üì∑</div>
  <button onclick="send()">‚ñ∂</button>
 </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
firebase.initializeApp({
 apiKey:"AIzaSyCbKw_YRxf38AxxqcKMfIvg9KqDTQxKzTU",
 databaseURL:"https://licei-47857-default-rtdb.firebaseio.com"
});
const db=firebase.database();

let id=localStorage.id||('entity_'+Math.random().toString(36).slice(2,9));
localStorage.id=id;
let ref=db.ref('rooms/hall');

/* SEND TEXT */
function send(){
 const t=text.value.trim();
 if(!t)return;
 ref.push({id,type:'text',text:t,time:Date.now()});
 text.value='';
}

/* RENDER */
ref.limitToLast(100).on('child_added',s=>render(s.key,s.val()));
function render(key,m){
 const d=document.createElement('div');
 d.className='msg '+(m.id===id?'me':'');

 if(m.type==='video'){
  const vs=document.createElement('div');
  vs.className='videoSquare';
  const v=document.createElement('video');
  v.src=m.video;v.controls=true;
  vs.appendChild(v);

  const t=document.createElement('div');
  t.className='timer';
  t.textContent=(m.dur||0)+'s';
  vs.appendChild(t);

  const reacts=document.createElement('div');
  reacts.className='reactions';
  reacts.innerHTML='<span>‚ù§Ô∏è</span><span>üî•</span><span>üëç</span>';
  reacts.onclick=()=>alert('—Ä–µ–∞–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞');

  const b=document.createElement('div');
  b.className='bubble';
  b.appendChild(vs);
  b.appendChild(reacts);

  if(m.id===id){
   const del=document.createElement('button');
   del.textContent='–£–¥–∞–ª–∏—Ç—å';
   del.onclick=()=>db.ref('rooms/hall/'+key).remove();
   b.appendChild(del);
  }
  d.appendChild(b);
 }else{
  d.innerHTML='<div class="bubble">'+m.text+'</div>';
 }
 messages.appendChild(d);
 messages.scrollTop=messages.scrollHeight;
}

/* CAMERA RECORD */
let rec,stream,chunks=[],recording=false,timer=0,intv;
camBtn.onmousedown=start;
camBtn.onmouseup=stop;
camBtn.onmouseleave=stop;

async function start(){
 if(recording)return;
 stream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
 rec=new MediaRecorder(stream,{mimeType:'video/webm'});
 chunks=[];
 rec.ondataavailable=e=>chunks.push(e.data);
 rec.onstop=save;
 rec.start();
 recording=true;
 timer=0;
 camBtn.classList.add('rec');
 camBtn.textContent='0s';
 intv=setInterval(()=>{
  timer++;camBtn.textContent=timer+'s';
  if(timer>=30)stop();
 },1000);
}

function stop(){
 if(!recording)return;
 rec.stop();
 stream.getTracks().forEach(t=>t.stop());
 clearInterval(intv);
 camBtn.classList.remove('rec');
 camBtn.textContent='üì∑';
 recording=false;
}

function save(){
 const blob=new Blob(chunks,{type:'video/webm'});
 const r=new FileReader();
 r.onload=e=>ref.push({id,type:'video',video:e.target.result,dur:timer,time:Date.now()});
 r.readAsDataURL(blob);
}
</script>
</body>
</html>
