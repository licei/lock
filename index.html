<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>THE WATCHING — Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root{--bg:#000;--panel:#070707;--accent:#b30000;--line:#300;--text:#e6e6e6}
*{box-sizing:border-box}
body{margin:0;background:#000;color:var(--text);font-family:system-ui,monospace;overflow:hidden}

/* TOP */
#top{position:fixed;top:0;left:0;right:0;display:flex;align-items:center;gap:8px;padding:8px;background:#000;border-bottom:1px solid var(--line);z-index:5}
button{background:#000;color:#ff6b6b;border:1px solid var(--accent);border-radius:10px;padding:6px 10px}

/* SLIDE PANEL */
#privatePanel{
 position:fixed;top:48px;left:0;bottom:0;width:200px;
 background:#050505;border-right:1px solid var(--line);
 transform:translateX(-100%);transition:.25s;z-index:4;
 padding:8px;overflow:auto
}
#privatePanel.open{transform:translateX(0)}
.pItem{display:flex;gap:6px;padding:6px;border-bottom:1px dashed #200;cursor:pointer}
.pItem:hover{background:#100}
.avatar{width:26px;height:26px;border-radius:50%;background:radial-gradient(circle,#ff6b6b,#700)}
.pMeta{flex:1}
.pName{font-size:13px}

/* CHAT */
#chat{position:fixed;left:0;right:0;bottom:0;top:48px;display:flex;flex-direction:column}
#messages{flex:1;overflow:auto;padding:12px}
.msg{max-width:80%;margin-bottom:10px}
.me{margin-left:auto}
.bubble{background:#080808;border:1px solid var(--line);border-radius:14px;padding:8px}
.meta{font-size:11px;color:#888;margin-top:4px}
.nick{cursor:pointer;color:#ff9a9a}

/* INPUT */
#inputBar{display:flex;gap:8px;padding:8px;border-top:1px solid var(--line)}
input{flex:1;background:#000;color:#eee;border:1px solid var(--line);border-radius:10px;padding:8px}
</style>
</head>
<body>

<div id="top">
 <button onclick="togglePrivate()">☰ Личные</button>
 <button onclick="goPublic()">Общий чат</button>
</div>

<div id="privatePanel"></div>

<div id="chat">
 <div id="messages"></div>
 <div id="inputBar">
  <input id="text" placeholder="сообщение">
  <button onclick="send()">▶</button>
 </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
firebase.initializeApp({
 apiKey:"AIzaSyCbKw_YRxf38AxxqcKMfIvg9KqDTQxKzTU",
 databaseURL:"https://licei-47857-default-rtdb.firebaseio.com"
});
const db=firebase.database();

let id=localStorage.id||('entity_'+Math.random().toString(36).slice(2,9));
localStorage.id=id;
let nick=localStorage.nick||id;
localStorage.nick=nick;

let mode='public',withUser=null,ref=null;
const messages=document.getElementById('messages');
const panel=document.getElementById('privatePanel');

function togglePrivate(){panel.classList.toggle('open')}

function goPublic(){mode='public';withUser=null;listen()}

function openPrivate(u){
 if(u===id)return;
 mode='private';withUser=u;
 panel.classList.remove('open');
 listen();
}

function listen(){
 if(ref)ref.off();
 messages.innerHTML='';
 ref = mode==='public'
  ? db.ref('rooms/hall')
  : db.ref('private/'+[id,withUser].sort().join('__'));
 ref.limitToLast(100).on('child_added',s=>render(s.val()));
}

function render(m){
 const d=document.createElement('div');
 d.className='msg '+(m.id===id?'me':'');
 d.innerHTML=`
 <div class="bubble">
  ${m.text}
  <div class="meta">
    <span class="nick" onclick="openPrivate('${m.id}')">${m.nick}</span>
    · ${new Date(m.time).toLocaleTimeString()}
  </div>
 </div>`;
 messages.appendChild(d);
 messages.scrollTop=messages.scrollHeight;
}

function send(){
 const t=text.value.trim(); if(!t)return;
 ref.push({id,nick,text:t,time:Date.now()});
 text.value='';
}

/* LOAD PRIVATE LIST */
db.ref('private').on('value',snap=>{
 panel.innerHTML='<b>Личные чаты</b><br><br>';
 snap.forEach(c=>{
  const users=c.key.split('__');
  if(!users.includes(id))return;
  const other=users.find(u=>u!==id);
  const div=document.createElement('div');
  div.className='pItem';
  div.onclick=()=>openPrivate(other);
  div.innerHTML=`
   <div class="avatar"></div>
   <div class="pMeta"><div class="pName">${other}</div></div>`;
  panel.appendChild(div);
 });
});

listen();
</script>
</body>
</html>
