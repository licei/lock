<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>THE WATCHING ‚Äî Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root{
 --bg:#000;--panel:#050505;--accent:#b30000;
 --line:#300;--text:#e6e6e6;
 --my1:#2a0000;--my2:#120000
}
*{box-sizing:border-box}
body{margin:0;background:#000;color:var(--text);font-family:system-ui,monospace;overflow-x:hidden}

/* ===== TOP BAR (–ù–ï –ú–ï–ù–Ø–õ) ===== */
#top{
 position:fixed;top:0;left:0;right:0;z-index:5;
 display:flex;align-items:center;gap:8px;
 padding:6px 8px;background:#000;border-bottom:1px solid var(--line)
}
#centerSearch{flex:1;text-align:center}
#centerSearch input{
 width:180px;background:#000;color:#eee;
 border:1px solid var(--line);border-radius:8px;padding:4px;font-size:12px
}
button{
 background:#000;color:#ff6b6b;border:1px solid var(--accent);
 border-radius:8px;padding:4px 8px;font-size:12px
}

/* ===== PRIVATE PANEL ===== */
#privatePanel{
 position:fixed;top:42px;left:0;bottom:0;width:165px;
 background:var(--panel);border-right:1px solid var(--line);
 transform:translateX(-100%);transition:.25s;z-index:4;
 padding:6px;overflow-y:auto
}
#privatePanel.open{transform:translateX(0)}
.pItem{display:flex;gap:6px;padding:4px;border-bottom:1px dashed #200;cursor:pointer}
.avatar{
 width:20px;height:20px;border-radius:50%;
 background-size:cover;background-position:center;flex-shrink:0
}
.pName{font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* ===== CHAT ===== */
#chat{
 position:fixed;left:0;right:0;bottom:0;top:42px;
 display:flex;flex-direction:column
}
#messages{
 flex:1;overflow-y:auto;overflow-x:hidden;padding:8px
}
.msg{width:100%;display:flex;margin-bottom:6px}
.msg.me{justify-content:flex-end}

.bubble{
 display:inline-flex;flex-direction:column;
 width:fit-content;max-width:78%;
 background:#080808;border:1px solid var(--line);
 border-radius:10px;padding:4px 6px;
 white-space:pre-wrap;word-break:break-word;
 line-height:1.15;font-size:12px
}
.msg.me .bubble{
 background:linear-gradient(180deg,var(--my1),var(--my2));
 border:1px solid #550000
}

/* ===== INPUT BAR (–ù–ï –ú–ï–ù–Ø–õ, –¢–û–õ–¨–ö–û + –ö–ù–û–ü–ö–ê) ===== */
#inputBar{
 display:flex;gap:6px;padding:6px;border-top:1px solid var(--line);
 align-items:flex-end
}
textarea{
 flex:1;background:#000;color:#eee;border:1px solid var(--line);
 border-radius:8px;padding:6px;resize:none;
 min-height:36px;max-height:120px;font-size:12px
}

/* RECORD BUTTON */
#recordBtn{
 width:34px;height:34px;
 background:#120000;border:1px solid #b30000;
 border-radius:6px;color:#ff6b6b;
 display:flex;align-items:center;justify-content:center;
 font-size:11px;user-select:none
}
#recordBtn.rec{background:#b30000;color:#000}
</style>
</head>
<body>

<!-- TOP BAR -->
<div id="top">
 <button onclick="togglePrivate()">‚ò∞</button>
 <button onclick="goPublic()">–û–±—â–∏–π</button>
 <div id="centerSearch">
  <input id="search" placeholder="–ø–æ–∏—Å–∫ –ø–æ ID" onkeydown="if(event.key==='Enter')searchUser()">
 </div>
 <button onclick="openProfile()">–ü—Ä–æ—Ñ–∏–ª—å</button>
</div>

<!-- PRIVATE PANEL -->
<div id="privatePanel"></div>

<!-- CHAT -->
<div id="chat">
 <div id="messages"></div>
 <div id="inputBar">
  <textarea id="text" placeholder="—Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶"></textarea>
  <div id="recordBtn">‚ñ†</div>
  <button onclick="send()">‚ñ∂</button>
 </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
firebase.initializeApp({
 apiKey:"AIzaSyCbKw_YRxf38AxxqcKMfIvg9KqDTQxKzTU",
 databaseURL:"https://licei-47857-default-rtdb.firebaseio.com"
});
const db=firebase.database();

let id=localStorage.id||('entity_'+Math.random().toString(36).slice(2,9));
localStorage.id=id;

let mode='public',withUser=null,ref=null;

/* UI */
function togglePrivate(){privatePanel.classList.toggle('open')}
function goPublic(){mode='public';withUser=null;listen()}
function searchUser(){
 const q=search.value.trim();
 if(q&&q!==id)openPrivate(q);
}
function openProfile(){alert('–ü—Ä–æ—Ñ–∏–ª—å —É–∂–µ –µ—Å—Ç—å, –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–µ –º–µ–Ω—è–ª—Å—è')}

/* CHAT */
function openPrivate(u){
 mode='private';withUser=u;
 privatePanel.classList.remove('open');
 listen();
}
function listen(){
 if(ref)ref.off();
 messages.innerHTML='';
 ref=mode==='public'
  ?db.ref('rooms/hall')
  :db.ref('private/'+[id,withUser].sort().join('__'));
 ref.limitToLast(100).on('child_added',s=>render(s.val()));
}
listen();

/* SEND TEXT */
function send(){
 const t=text.value.trim();
 if(!t)return;
 ref.push({id,type:'text',text:t,time:Date.now()});
 text.value='';
}

/* RENDER */
function render(m){
 const d=document.createElement('div');
 d.className='msg '+(m.id===id?'me':'');
 if(m.type==='voice'){
  d.innerHTML='<div class="bubble">üéôÔ∏è '+(m.dur||0)+'s ‚ñ∂</div>';
 }else{
  d.innerHTML='<div class="bubble">'+m.text+'</div>';
 }
 messages.appendChild(d);
 messages.scrollTop=messages.scrollHeight;
}

/* ===== HOLD TO RECORD (–î–û–ë–ê–í–õ–ï–ù–û) ===== */
let recorder,stream,chunks=[],recording=false,timer=0,intv;
const btn=document.getElementById('recordBtn');

btn.addEventListener('mousedown',start);
btn.addEventListener('touchstart',start,{passive:false});
btn.addEventListener('mouseup',stop);
btn.addEventListener('mouseleave',stop);
btn.addEventListener('touchend',stop);

async function start(e){
 if(recording)return;
 e.preventDefault();
 stream=await navigator.mediaDevices.getUserMedia({audio:true});
 recorder=new MediaRecorder(stream);
 chunks=[];
 recorder.ondataavailable=e=>chunks.push(e.data);
 recorder.onstop=save;
 recorder.start();
 recording=true;
 timer=0;
 btn.classList.add('rec');
 btn.textContent='0s';
 intv=setInterval(()=>{
  timer++;btn.textContent=timer+'s';
 },1000);
}
function stop(){
 if(!recording)return;
 recorder.stop();
 stream.getTracks().forEach(t=>t.stop());
 clearInterval(intv);
 btn.classList.remove('rec');
 btn.textContent='‚ñ†';
 recording=false;
}
function save(){
 if(!chunks.length)return;
 const blob=new Blob(chunks,{type:'audio/webm'});
 const r=new FileReader();
 r.onload=e=>{
  ref.push({id,type:'voice',audio:e.target.result,dur:timer,time:Date.now()});
 };
 r.readAsDataURL(blob);
}
</script>
</body>
</html>
