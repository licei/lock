<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>THE WATCHING</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
*{box-sizing:border-box}
body{
  margin:0;
  background:#000;
  color:#c00000;
  font-family:monospace;
  overflow:hidden;
}

/* EYE */
#eye{
  position:fixed;
  top:30%;
  left:50%;
  transform:translate(-50%,-50%);
  width:240px;height:240px;border-radius:50%;
  background:radial-gradient(circle,#fff 0%,#ffcccc 20%,#aa0000 45%,#400000 70%,#000 100%);
  box-shadow:inset 0 0 40px #600,0 0 120px #900;
}
#iris{position:absolute;inset:60px;border-radius:50%;background:radial-gradient(circle,#600,#000)}
#pupil{position:absolute;inset:30px;border-radius:50%;background:#000}
#lid{position:absolute;inset:0;background:#000;border-radius:50%;transform:scaleY(0);animation:blink 6s infinite}
@keyframes blink{0%,95%,100%{transform:scaleY(0)}96%{transform:scaleY(1)}}

/* TOP */
#top{
  position:fixed;top:0;left:0;right:0;
  display:flex;justify-content:space-between;
  padding:6px;z-index:5;
}
#privates button{
  margin-left:4px;
  font-size:11px;
}

/* UI */
#ui{
  position:fixed;bottom:0;left:0;right:0;
  background:#050505;border-top:1px solid #600;padding:6px;
}
#messages{
  height:32vh;overflow:auto;border:1px solid #600;padding:6px;margin-bottom:4px;
}
.msg{margin-bottom:4px}
.nick{color:#ff5555;cursor:pointer}
.time{opacity:.6;font-size:11px;margin-left:4px}

input,button{
  background:#000;color:#c00000;border:1px solid #600;padding:6px;
}

/* ARCHIVE */
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.92);display:none;z-index:9}
#archive{position:fixed;inset:20px;background:#020;border:1px solid #600;display:none;z-index:10;padding:10px;overflow:auto}
</style>
</head>
<body>

<div id="eye">
  <div id="iris"><div id="pupil"></div></div>
  <div id="lid"></div>
</div>

<div id="top">
  <button onclick="goPublic()">ОБЩИЙ</button>
  <div id="privates"></div>
</div>

<div id="overlay"></div>
<div id="archive">
  <button onclick="closeArchive()">закрыть</button>
  <h3>ЛИЧНЫЙ АРХИВ</h3>
  <div id="archiveList"></div>
</div>

<div id="ui">
  <div id="messages"></div>
  <input id="text" placeholder="сообщение (/archive)">
  <button onclick="send()">▶</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig={
 apiKey:"AIzaSyCbKw_YRxf38AxxqcKMfIvg9KqDTQxKzTU",
 authDomain:"licei-47857.firebaseapp.com",
 databaseURL:"https://licei-47857-default-rtdb.firebaseio.com",
 projectId:"licei-47857",
 storageBucket:"licei-47857.firebasestorage.app",
 messagingSenderId:"693615263006",
 appId:"1:693615263006:web:e9309536d58ae848b49d0f"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

let me=localStorage.getItem('entity_name');
if(!me){me='entity_'+Math.random().toString(36).slice(2,8);localStorage.setItem('entity_name',me);}

/* EYE FOLLOW */
function follow(x,y){
 const dx=(x/innerWidth-.5)*40;
 const dy=(y/innerHeight-.5)*40;
 iris.style.transform=`translate(${dx}px,${dy}px)`;
 pupil.style.transform=`translate(${dx/2}px,${dy/2}px)`;
}
addEventListener('mousemove',e=>follow(e.clientX,e.clientY));
addEventListener('touchmove',e=>{if(e.touches[0])follow(e.touches[0].clientX,e.touches[0].clientY)},{passive:true});

let mode='public',currentRef,privateWith=null;
const privSet=new Set();

function fmt(t){return new Date(t).toLocaleTimeString();}

function listen(){
 if(currentRef) currentRef.off();
 messages.innerHTML='';
 if(mode==='public'){
  currentRef=db.ref('rooms/hall');
 }else{
  const key=[me,privateWith].sort().join('__');
  currentRef=db.ref('private/'+key);
 }
 currentRef.limitToLast(100).on('child_added',s=>{
  const m=s.val();
  messages.innerHTML+=
   `<div class="msg">
     <span class="nick" onclick="openPrivate('${m.name}')">[${m.name}]</span>
     ${m.text}<span class="time">${fmt(m.time)}</span>
    </div>`;
  messages.scrollTop=9999;
 });
}

function openPrivate(name){
 if(name===me) return;
 mode='private'; privateWith=name;
 if(!privSet.has(name)){
  privSet.add(name);
  const b=document.createElement('button');
  b.textContent=name;
  b.onclick=()=>openPrivate(name);
  privates.appendChild(b);
 }
 listen();
}

function goPublic(){
 mode='public'; privateWith=null; listen();
}

function send(){
 const t=text.value.trim();
 if(!t) return;
 if(t==='/archive'){openArchive();text.value='';return;}
 currentRef.push({name:me,text:t,time:Date.now()});
 text.value='';
}

/* ARCHIVE */
function openArchive(){
 overlay.style.display=archive.style.display='block';
 archiveList.innerHTML='';
 db.ref().once('value',snap=>{
  snap.forEach(a=>a.forEach(b=>b.forEach(c=>{
   const m=c.val();
   if(m&&m.name===me){
    archiveList.innerHTML+=`<div>${m.text} <span class="time">${new Date(m.time).toLocaleString()}</span></div>`;
   }
  })));
 });
}
function closeArchive(){overlay.style.display=archive.style.display='none';}

listen();
</script>
</body>
</html>
