<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>THE WATCHING</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
*{box-sizing:border-box}
body{
  margin:0;
  background:
    radial-gradient(circle at center,#200000 0%,#000 70%),
    repeating-linear-gradient(45deg,rgba(255,0,0,.03) 0 2px,transparent 2px 6px);
  color:#c00000;
  font-family:monospace;
  overflow:hidden;
}

/* === EYE === */
#eye{
  position:fixed;
  top:30%;
  left:50%;
  transform:translate(-50%,-50%);
  width:240px;
  height:240px;
  border-radius:50%;
  background:
    radial-gradient(circle at 50% 50%,#fff 0%,#ffcccc 20%,#aa0000 45%,#400000 70%,#000 100%);
  box-shadow:
    inset 0 0 40px #600,
    0 0 120px #900;
}
#iris{
  position:absolute;
  inset:60px;
  border-radius:50%;
  background:radial-gradient(circle,#600 0%,#300 60%,#000 100%);
}
#pupil{
  position:absolute;
  inset:30px;
  border-radius:50%;
  background:#000;
}
#lid{
  position:absolute;
  inset:0;
  background:#000;
  border-radius:50%;
  transform:scaleY(0);
  transform-origin:center;
  animation:blink 5s infinite;
}
@keyframes blink{
  0%,94%,100%{transform:scaleY(0)}
  95%{transform:scaleY(1)}
}

/* === UI === */
#top{
  position:fixed;
  top:0;left:0;right:0;
  display:flex;
  justify-content:flex-end;
  padding:6px;
  z-index:5;
}
#privates{
  max-width:45vw;
  font-size:12px;
  text-align:right;
}
#privates div{
  cursor:pointer;
  opacity:.7;
}
#privates div:hover{opacity:1}

#ui{
  position:fixed;
  bottom:0;left:0;right:0;
  background:rgba(0,0,0,.85);
  border-top:1px solid #600;
  padding:6px;
}
#messages{
  height:32vh;
  overflow:auto;
  border:1px solid #600;
  padding:6px;
  margin-bottom:4px;
}
.msg{margin-bottom:4px}
.nick{color:#ff5555;cursor:pointer}
.time{opacity:.6;font-size:11px;margin-left:4px}

input,button{
  background:#000;
  color:#c00000;
  border:1px solid #600;
  padding:6px;
  font-size:14px;
}
#controls{display:flex;gap:4px}

/* === ARCHIVE === */
#overlay{
  position:fixed;inset:0;
  background:rgba(0,0,0,.92);
  display:none;z-index:9;
}
#archive{
  position:fixed;inset:20px;
  background:#020;
  border:1px solid #600;
  display:none;z-index:10;
  padding:10px;
  overflow:auto;
}
</style>
</head>
<body>

<div id="eye">
  <div id="iris">
    <div id="pupil"></div>
  </div>
  <div id="lid"></div>
</div>

<div id="top">
  <div id="privates"></div>
</div>

<div id="overlay"></div>
<div id="archive">
  <button onclick="closeArchive()">закрыть</button>
  <h3>ЛИЧНЫЙ АРХИВ</h3>
  <div id="archiveList"></div>
</div>

<div id="ui">
  <div id="messages"></div>
  <div id="controls">
    <input id="text" placeholder="сообщение (/archive)">
    <button onclick="send()">▶</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
/* FIREBASE */
const firebaseConfig={
 apiKey:"AIzaSyCbKw_YRxf38AxxqcKMfIvg9KqDTQxKzTU",
 authDomain:"licei-47857.firebaseapp.com",
 databaseURL:"https://licei-47857-default-rtdb.firebaseio.com",
 projectId:"licei-47857",
 storageBucket:"licei-47857.firebasestorage.app",
 messagingSenderId:"693615263006",
 appId:"1:693615263006:web:e9309536d58ae848b49d0f"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

/* ID */
let me=localStorage.getItem('entity_name');
if(!me){
 me='entity_'+Math.random().toString(36).slice(2,8);
 localStorage.setItem('entity_name',me);
}

/* EYE FOLLOW (MOUSE + TOUCH) */
function follow(x,y){
 const dx=(x/innerWidth-.5)*40;
 const dy=(y/innerHeight-.5)*40;
 iris.style.transform=`translate(${dx}px,${dy}px)`;
 pupil.style.transform=`translate(${dx/2}px,${dy/2}px)`;
}
addEventListener('mousemove',e=>follow(e.clientX,e.clientY));
addEventListener('touchmove',e=>{
 if(e.touches[0]) follow(e.touches[0].clientX,e.touches[0].clientY);
},{passive:true});

/* CHAT LOGIC */
let mode='public',currentRef,privateWith=null;
const messages=document.getElementById('messages');

function fmt(t){return new Date(t).toLocaleTimeString();}

function listen(){
 if(currentRef) currentRef.off();
 messages.innerHTML='';
 if(mode==='public'){
  currentRef=db.ref('rooms/hall');
 }else{
  const key=[me,privateWith].sort().join('__');
  currentRef=db.ref('private/'+key);
 }
 currentRef.limitToLast(100).on('child_added',s=>{
  const m=s.val();
  messages.innerHTML+=
   `<div class="msg">
    <span class="nick" onclick="openPrivate('${m.name}')">[${m.name}]</span>
    ${m.text}<span class="time">${fmt(m.time)}</span>
   </div>`;
  messages.scrollTop=9999;
 });
}

function openPrivate(name){
 if(name===me) return;
 mode='private';
 privateWith=name;
 addPrivate(name);
 listen();
}

function addPrivate(name){
 const d=document.createElement('div');
 d.textContent=name;
 d.onclick=()=>openPrivate(name);
 privates.appendChild(d);
}

function send(){
 const t=text.value.trim();
 if(!t) return;
 if(t==='/archive'){openArchive();text.value='';return;}
 currentRef.push({name:me,text:t,time:Date.now()});
 text.value='';
}

/* ARCHIVE */
function openArchive(){
 overlay.style.display=archive.style.display='block';
 archiveList.innerHTML='';
 db.ref().once('value',snap=>{
  snap.forEach(a=>a.forEach(b=>b.forEach(c=>{
   const m=c.val();
   if(m&&m.name===me){
    archiveList.innerHTML+=`<div>${m.text} <span class="time">${new Date(m.time).toLocaleString()}</span></div>`;
   }
  })));
 });
}
function closeArchive(){
 overlay.style.display=archive.style.display='none';
}

listen();
</script>
</body>
</html>
